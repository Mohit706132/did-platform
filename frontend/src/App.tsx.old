// Redesigned DID Platform - Indian Context
import { useEffect, useState } from "react";
import "./App.css";
import { DID_METHOD_PREFIX } from "./blockchain/config";

const BACKEND_URL = import.meta.env.VITE_BACKEND_URL || "http://localhost:4000";

type UserRole = 'user' | 'issuer' | 'verifier';

interface User {
  email: string;
  firstName: string;
  lastName: string;
  role: UserRole;
}

// Indian document templates
const INDIAN_DOCUMENTS = {
  aadhar: {
    name: 'Aadhaar Card',
    icon: 'üÜî',
    fields: [
      { name: 'aadharNumber', label: 'Aadhaar Number', type: 'text', placeholder: '1234 5678 9012' },
      { name: 'fullName', label: 'Full Name', type: 'text' },
      { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
      { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'] },
      { name: 'address', label: 'Address', type: 'textarea' },
    ]
  },
  pan: {
    name: 'PAN Card',
    icon: 'üí≥',
    fields: [
      { name: 'panNumber', label: 'PAN Number', type: 'text', placeholder: 'ABCDE1234F' },
      { name: 'fullName', label: 'Full Name', type: 'text' },
      { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
      { name: 'fatherName', label: "Father's Name", type: 'text' },
    ]
  },
  dl: {
    name: 'Driving License',
    icon: 'üöó',
    fields: [
      { name: 'licenseNumber', label: 'License Number', type: 'text' },
      { name: 'fullName', label: 'Full Name', type: 'text' },
      { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
      { name: 'validUpto', label: 'Valid Upto', type: 'date' },
      { name: 'vehicleClass', label: 'Vehicle Class', type: 'text', placeholder: 'LMV, MCWG' },
    ]
  },
};

function App() {
  // Auth
  const [isAuth, setIsAuth] = useState(false);
  const [sessionId, setSessionId] = useState("");
  const [user, setUser] = useState<User | null>(null);
  const [authMode, setAuthMode] = useState<'login' | 'register'>('login');
  
  // Form
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  
  // Wallet
  const [wallet, setWallet] = useState("");
  const [did, setDid] = useState("");
  
  // UI
  const [view, setView] = useState<'dashboard' | 'credentials' | 'verify' | 'issue'>('dashboard');
  const [credentials, setCredentials] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState<{ type: string, msg: string } | null>(null);
  const [modal, setModal] = useState<any>(null);
  const [verifyInput, setVerifyInput] = useState("");
  const [verifyResult, setVerifyResult] = useState<any>(null);
  
  // Issue credential state
  const [selectedTemplate, setSelectedTemplate] = useState('');
  const [credentialForm, setCredentialForm] = useState<Record<string, any>>({});
  
  // Share credential state
  const [shareModal, setShareModal] = useState<any>(null);
  const [selectedFields, setSelectedFields] = useState<string[]>([]);

  // Credential templates
  const credentialTemplates = {
    aadhar: {
      name: 'üÜî Aadhar Card',
      type: 'AadharCredential',
      fields: [
        { name: 'aadharNumber', label: 'Aadhar Number', type: 'text', placeholder: '1234 5678 9012' },
        { name: 'fullName', label: 'Full Name', type: 'text', placeholder: 'As per Aadhar' },
        { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
        { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'] },
        { name: 'address', label: 'Address', type: 'textarea', placeholder: 'Full address' },
        { name: 'pincode', label: 'Pincode', type: 'text', placeholder: '400001' },
      ]
    },
    pan: {
      name: 'üí≥ PAN Card',
      type: 'PANCredential',
      fields: [
        { name: 'panNumber', label: 'PAN Number', type: 'text', placeholder: 'ABCDE1234F' },
        { name: 'fullName', label: 'Full Name', type: 'text', placeholder: 'As per PAN' },
        { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
        { name: 'fatherName', label: 'Father Name', type: 'text' },
      ]
    },
    drivingLicense: {
      name: 'üöó Driving License',
      type: 'DrivingLicenseCredential',
      fields: [
        { name: 'licenseNumber', label: 'License Number', type: 'text', placeholder: 'DL-1420110012345' },
        { name: 'fullName', label: 'Full Name', type: 'text' },
        { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
        { name: 'issueDate', label: 'Issue Date', type: 'date' },
        { name: 'expiryDate', label: 'Expiry Date', type: 'date' },
        { name: 'vehicleClasses', label: 'Vehicle Classes', type: 'text', placeholder: 'LMV, MCWG' },
        { name: 'bloodGroup', label: 'Blood Group', type: 'select', options: ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'] },
      ]
    },
    education: {
      name: 'üéì Education Certificate',
      type: 'EducationCredential',
      fields: [
        { name: 'certificateNumber', label: 'Certificate Number', type: 'text' },
        { name: 'studentName', label: 'Student Name', type: 'text' },
        { name: 'degree', label: 'Degree/Course', type: 'text', placeholder: 'B.Tech Computer Science' },
        { name: 'institution', label: 'Institution', type: 'text', placeholder: 'University Name' },
        { name: 'yearOfPassing', label: 'Year of Passing', type: 'text', placeholder: '2024' },
        { name: 'grade', label: 'Grade/CGPA', type: 'text', placeholder: '8.5 CGPA' },
        { name: 'specialization', label: 'Specialization', type: 'text' },
      ]
    },
    employment: {
      name: 'üíº Employment Certificate',
      type: 'EmploymentCredential',
      fields: [
        { name: 'employeeId', label: 'Employee ID', type: 'text' },
        { name: 'fullName', label: 'Full Name', type: 'text' },
        { name: 'designation', label: 'Designation', type: 'text', placeholder: 'Software Engineer' },
        { name: 'department', label: 'Department', type: 'text' },
        { name: 'joiningDate', label: 'Joining Date', type: 'date' },
        { name: 'salary', label: 'Salary (Annual)', type: 'text', placeholder: '12,00,000' },
        { name: 'companyName', label: 'Company Name', type: 'text' },
      ]
    },
    voter: {
      name: 'üó≥Ô∏è Voter ID',
      type: 'VoterIDCredential',
      fields: [
        { name: 'voterId', label: 'Voter ID Number', type: 'text', placeholder: 'ABC1234567' },
        { name: 'fullName', label: 'Full Name', type: 'text' },
        { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' },
        { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'] },
        { name: 'constituency', label: 'Constituency', type: 'text' },
        { name: 'state', label: 'State', type: 'text' },
      ]
    },
    other: {
      name: 'üìÑ Other Document',
      type: 'OtherCredential',
      fields: [
        { name: 'documentName', label: 'Name on Document', type: 'text', placeholder: 'John Doe' },
        { name: 'uniqueId', label: 'Unique ID', type: 'text', placeholder: 'DOC123456789' },
        { name: 'age', label: 'Age', type: 'number', placeholder: '25' },
      ]
    },
  };

  useEffect(() => {
    const saved = localStorage.getItem("session");
    if (saved) {
      const data = JSON.parse(saved);
      setSessionId(data.sessionId);
      setUser(data.user);
      setIsAuth(true);
      loadCreds(data.sessionId);
    }
  }, []);

  const msg = (type: string, msg: string) => {
    setStatus({ type, msg });
    setTimeout(() => setStatus(null), 4000);
  };

  const handleAuth = async () => {
    if (authMode === 'register' && (!firstName || !lastName)) {
      return msg('error', 'Please fill all fields');
    }
    if (!email || !password) return msg('error', 'Email and password required');

    try {
      setLoading(true);
      const url = `/api/auth/${authMode}`;
      const body = authMode === 'register' 
        ? { email, password, firstName, lastName }
        : { email, password };

      const res = await fetch(BACKEND_URL + url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Auth failed');
      }

      const data = await res.json();
      setSessionId(data.sessionId);
      setUser(data.user || { email, firstName, lastName });
      setIsAuth(true);
      localStorage.setItem("session", JSON.stringify({ sessionId: data.sessionId, user: data.user || { email, firstName, lastName } }));
      msg('success', authMode === 'register' ? 'Account created!' : 'Logged in!');
      setEmail(""); setPassword(""); setFirstName(""); setLastName("");
      loadCreds(data.sessionId);
    } catch (e: any) {
      msg('error', e.message);
    } finally {
      setLoading(false);
    }
  };

  const logout = async () => {
    try {
      await fetch(BACKEND_URL + '/api/auth/logout', {
        method: 'POST',
        headers: { 'x-session-id': sessionId }
      });
    } catch {}
    setIsAuth(false);
    setSessionId("");
    setUser(null);
    setCredentials([]);
    setWallet("");
    setDid("");
    localStorage.removeItem("session");
    msg('info', 'Logged out');
  };

  const connectWallet = async () => {
    try {
      setLoading(true);
      const addr = await getCurrentAddress();
      setWallet(addr);
      setDid(`${DID_METHOD_PREFIX}${addr}`);
      msg('success', 'Wallet connected!');
    } catch (e: any) {
      msg('error', e.message || 'Wallet connection failed');
    } finally {
      setLoading(false);
    }
  };

  const loadCreds = async (sid: string) => {
    try {
      const res = await fetch(BACKEND_URL + '/api/credentials?page=1&limit=50', {
        headers: { 'x-session-id': sid }
      });
      if (res.ok) {
        const data = await res.json();
        setCredentials(data.credentials || []);
      }
    } catch (e) {}
  };

  const handleFormChange = (field: string, value: any) => {
    setCredentialForm(prev => ({ ...prev, [field]: value }));
  };

  const issueCred = async () => {
    if (!did && !wallet) return msg('error', 'Connect wallet first');
    if (!selectedTemplate) return msg('error', 'Select a credential type');

    const template = credentialTemplates[selectedTemplate as keyof typeof credentialTemplates];
    const missingFields = template.fields.filter(f => !credentialForm[f.name]);
    if (missingFields.length > 0) {
      return msg('error', `Please fill: ${missingFields[0].label}`);
    }

    try {
      setLoading(true);
      const res = await fetch(BACKEND_URL + '/api/credentials/issue', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
        body: JSON.stringify({
          subjectDid: did || `${DID_METHOD_PREFIX}${wallet}`,
          claims: credentialForm,
          type: ["VerifiableCredential", template.type],
          metadata: {
            credentialType: template.type,
            purpose: 'identity-verification'
          }
        })
      });

      if (!res.ok) throw new Error('Issue failed');
      msg('success', `${template.name} issued successfully!`);
      setSelectedTemplate('');
      setCredentialForm({});
      setView('credentials');
      loadCreds(sessionId);
    } catch (e: any) {
      msg('error', e.message);
    } finally {
      setLoading(false);
    }
  };

  const shareCredential = (cred: any) => {
    setShareModal(cred);
    setSelectedFields([]);
  };

  const toggleField = (field: string) => {
    setSelectedFields(prev => 
      prev.includes(field) ? prev.filter(f => f !== field) : [...prev, field]
    );
  };

  const generateShareableCredential = () => {
    if (!shareModal || selectedFields.length === 0) {
      return msg('error', 'Select at least one field to share');
    }

    const fullCred = shareModal.credentialData;
    const filteredClaims = Object.keys(fullCred.credentialSubject)
      .filter(key => key === 'id' || selectedFields.includes(key))
      .reduce((obj: any, key) => {
        obj[key] = fullCred.credentialSubject[key];
        return obj;
      }, {});

    const shareableCred = {
      ...fullCred,
      credentialSubject: filteredClaims,
      metadata: {
        ...fullCred.metadata,
        sharedFields: selectedFields,
        sharedAt: new Date().toISOString()
      }
    };

    setVerifyInput(JSON.stringify(shareableCred, null, 2));
    setView('verify');
    setShareModal(null);
    setSelectedFields([]);
    msg('info', 'Credential prepared for sharing with selected fields only');
  };

  const deleteCredential = async (credentialId: string) => {
    if (!confirm('Are you sure you want to delete this credential?')) return;

    try {
      setLoading(true);
      const res = await fetch(BACKEND_URL + `/api/credentials/${credentialId}/revoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
        body: JSON.stringify({ reason: 'Deleted by user' })
      });

      if (!res.ok) throw new Error('Delete failed');
      msg('success', 'Credential deleted successfully!');
      loadCreds(sessionId);
    } catch (e: any) {
      msg('error', e.message || 'Failed to delete credential');
    } finally {
      setLoading(false);
    }
  };

  const getCredentialTitle = (cred: any) => {
    const type = cred.credentialData?.type?.[1];
    if (!type) return 'Verifiable Credential';
    
    // Match the type to template name
    const template = Object.values(credentialTemplates).find(t => t.type === type);
    return template ? template.name : type.replace(/Credential$/, '').replace(/([A-Z])/g, ' $1').trim();
  };

  const verifyCred = async () => {
    if (!verifyInput.trim()) return msg('error', 'Paste credential JSON');

    try {
      setLoading(true);
      const parsed = JSON.parse(verifyInput);
      const res = await fetch(BACKEND_URL + '/api/credentials/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
        body: JSON.stringify(parsed)
      });

      if (!res.ok) throw new Error('Verify failed');
      const result = await res.json();
      setVerifyResult(result);
      msg(result.valid ? 'success' : 'error', result.valid ? 'Valid!' : 'Invalid: ' + result.reason);
    } catch (e: any) {
      msg('error', e.message);
    } finally {
      setLoading(false);
    }
  };

  if (!isAuth) {
    return (
      <div className="app-root">
        {status && <div className={`alert alert-${status.type}`}>{status.msg}</div>}
        <div className="auth-container">
          <div className="auth-card">
            <h2 style={{ textAlign: 'center', marginBottom: '2rem' }}>üîê DID Platform</h2>
            <div className="auth-tabs">
              <button className={`auth-tab ${authMode === 'login' ? 'active' : ''}`} onClick={() => setAuthMode('login')}>Login</button>
              <button className={`auth-tab ${authMode === 'register' ? 'active' : ''}`} onClick={() => setAuthMode('register')}>Register</button>
            </div>
            {authMode === 'register' && (
              <>
                <div className="form-group">
                  <label>First Name</label>
                  <input value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="John" />
                </div>
                <div className="form-group">
                  <label>Last Name</label>
                  <input value={lastName} onChange={e => setLastName(e.target.value)} placeholder="Doe" />
                </div>
              </>
            )}
            <div className="form-group">
              <label>Email</label>
              <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="you@example.com" />
            </div>
            <div className="form-group">
              <label>Password</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <button className="btn btn-primary btn-full" onClick={handleAuth} disabled={loading}>
              {loading && <span className="loading"></span>}
              {authMode === 'login' ? 'Sign In' : 'Create Account'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="app-root">
      <header className="app-header">
        <h1>üîê DID Platform</h1>
        <p>Decentralized Identity & Verifiable Credentials</p>
      </header>

      {status && <div className={`alert alert-${status.type}`}>{status.msg}</div>}

      <div className="card">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div className="button-group">
            <button className={`btn ${view === 'dashboard' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('dashboard')}>üè† Dashboard</button>
            <button className={`btn ${view === 'issue' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('issue')}>‚ûï Issue</button>
            <button className={`btn ${view === 'credentials' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('credentials')}>üìã Credentials</button>
            <button className={`btn ${view === 'verify' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('verify')}>‚úÖ Verify</button>
          </div>
          <button className="btn btn-secondary" onClick={logout}>üö™ Logout</button>
        </div>
      </div>

      {view === 'dashboard' && (
        <>
          <div className="dashboard-grid">
            <div className="stat-card">
              <h3>Total Credentials</h3>
              <div className="stat-value">{credentials.length}</div>
            </div>
            <div className="stat-card">
              <h3>Active</h3>
              <div className="stat-value">{credentials.filter(c => c.status === 'ACTIVE').length}</div>
            </div>
            <div className="stat-card">
              <h3>Wallet</h3>
              <div className="stat-value">{wallet ? 'üü¢' : 'üî¥'}</div>
            </div>
          </div>

          <div className="card">
            <h2>üë§ Profile</h2>
            <div className="user-info">
              <div className="user-info-item">
                <span className="user-info-label">Name</span>
                <span className="user-info-value">{user?.firstName} {user?.lastName}</span>
              </div>
              <div className="user-info-item">
                <span className="user-info-label">Email</span>
                <span className="user-info-value">{user?.email}</span>
              </div>
              {wallet && (
                <div className="user-info-item">
                  <span className="user-info-label">Wallet</span>
                  <span className="user-info-value">{wallet.slice(0, 10)}...{wallet.slice(-8)}</span>
                </div>
              )}
            </div>
          </div>

          <div className="card">
            <h2>üöÄ Quick Actions</h2>
            <div className="button-group">
              {!wallet && <button className="btn btn-primary" onClick={connectWallet} disabled={loading}>üîó Connect Wallet</button>}
              <button className="btn btn-success" onClick={() => setView('issue')} disabled={!wallet}>‚ûï Issue New Credential</button>
              <button className="btn btn-secondary" onClick={() => setView('credentials')}>üìã View All Credentials</button>
            </div>
          </div>
        </>
      )}

      {view === 'issue' && (
        <div className="card">
          <h2>‚ûï Issue New Credential</h2>
          
          {!selectedTemplate ? (
            <>
              <p>Select the type of credential you want to issue:</p>
              <div className="credentials-list" style={{ marginTop: '1.5rem' }}>
                {Object.entries(credentialTemplates).map(([key, template]) => (
                  <div key={key} className="credential-item" style={{ cursor: 'pointer' }} onClick={() => setSelectedTemplate(key)}>
                    <div className="credential-header">
                      <div className="credential-title">{template.name}</div>
                      <span style={{ fontSize: '1.5rem' }}>‚Üí</span>
                    </div>
                    <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginTop: '0.5rem' }}>
                      {template.fields.length} fields required
                    </p>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                <h3>{credentialTemplates[selectedTemplate as keyof typeof credentialTemplates].name}</h3>
                <button className="btn btn-secondary" onClick={() => { setSelectedTemplate(''); setCredentialForm({}); }}>‚Üê Back</button>
              </div>
              
              {credentialTemplates[selectedTemplate as keyof typeof credentialTemplates].fields.map((field) => (
                <div key={field.name} className="form-group">
                  <label>{field.label}</label>
                  {field.type === 'textarea' ? (
                    <textarea
                      value={credentialForm[field.name] || ''}
                      onChange={(e) => handleFormChange(field.name, e.target.value)}
                      placeholder={field.placeholder}
                    />
                  ) : field.type === 'select' ? (
                    <select
                      value={credentialForm[field.name] || ''}
                      onChange={(e) => handleFormChange(field.name, e.target.value)}
                    >
                      <option value="">Select {field.label}</option>
                      {'options' in field && field.options?.map((opt: string) => <option key={opt} value={opt}>{opt}</option>)}
                    </select>
                  ) : (
                    <input
                      type={field.type}
                      value={credentialForm[field.name] || ''}
                      onChange={(e) => handleFormChange(field.name, e.target.value)}
                      placeholder={field.placeholder}
                    />
                  )}
                </div>
              ))}
              
              <button className="btn btn-success btn-full" onClick={issueCred} disabled={loading}>
                {loading && <span className="loading"></span>}
                Issue Credential
              </button>
            </>
          )}
        </div>
      )}

      {view === 'credentials' && (
        <div className="card">
          <h2>üìã My Credentials</h2>
          {credentials.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">üì≠</div>
              <div className="empty-state-title">No credentials yet</div>
              <button className="btn btn-primary" onClick={issueCred}>Issue Credential</button>
            </div>
          ) : (
            <div className="credentials-list">
              {credentials.map(c => (
                <div key={c.credentialId} className="credential-item">
                  <div className="credential-header">
                    <div className="credential-title">{getCredentialTitle(c)}</div>
                    <span className={`credential-status ${c.status.toLowerCase()}`}>{c.status}</span>
                  </div>
                  <div className="credential-meta">
                    <div className="credential-meta-item">
                      <div className="credential-meta-label">Issued</div>
                      <div className="credential-meta-value">{new Date(c.issuedAt).toLocaleDateString()}</div>
                    </div>
                  </div>
                  <div className="button-group" style={{ marginTop: '1rem' }}>
                    <button className="btn btn-secondary" onClick={() => setModal(c)}>View Details</button>
                    {c.status === 'ACTIVE' && (
                      <button className="btn btn-primary" onClick={() => shareCredential(c)}>üì§ Share</button>
                    )}
                    <button className="btn btn-danger" onClick={() => deleteCredential(c.credentialId)}>üóëÔ∏è Delete</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {view === 'verify' && (
        <div className="card">
          <h2>‚úÖ Verify Credential</h2>
          <div className="form-group">
            <label>Credential JSON</label>
            <textarea style={{ minHeight: '300px', fontFamily: 'monospace' }} value={verifyInput} onChange={e => setVerifyInput(e.target.value)} placeholder='{"@context": ...}' />
          </div>
          <button className="btn btn-primary" onClick={verifyCred} disabled={loading}>üîç Verify</button>
          {verifyResult && (
            <div className={`alert ${verifyResult.valid ? 'alert-success' : 'alert-error'}`} style={{ marginTop: '1rem' }}>
              <strong>{verifyResult.valid ? '‚úÖ Valid' : '‚ùå Invalid'}</strong>
              {!verifyResult.valid && <p>Reason: {verifyResult.reason}</p>}
            </div>
          )}
        </div>
      )}

      {modal && (
        <div className="modal-overlay" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Credential Details</h3>
              <button className="modal-close" onClick={() => setModal(null)}>√ó</button>
            </div>
            <pre>{JSON.stringify(modal, null, 2)}</pre>
          </div>
        </div>
      )}

      {shareModal && (
        <div className="modal-overlay" onClick={() => setShareModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">üì§ Share Credential - Select Fields</h3>
              <button className="modal-close" onClick={() => setShareModal(null)}>√ó</button>
            </div>
            <p style={{ marginBottom: '1.5rem', color: 'var(--text-secondary)' }}>
              Select only the fields you want to share with the verifier. This ensures privacy by revealing only necessary information.
            </p>
            
            <div style={{ marginBottom: '1.5rem' }}>
              {Object.keys(shareModal.credentialData?.credentialSubject || {}).filter(key => key !== 'id').map(field => (
                <div key={field} style={{ 
                  padding: '0.75rem', 
                  marginBottom: '0.5rem', 
                  background: 'var(--bg-secondary)', 
                  borderRadius: '8px',
                  cursor: 'pointer',
                  border: selectedFields.includes(field) ? '2px solid var(--primary)' : '2px solid transparent',
                  transition: 'all 0.2s ease'
                }} onClick={() => toggleField(field)}>
                  <label style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                    <input 
                      type="checkbox" 
                      checked={selectedFields.includes(field)}
                      onChange={() => toggleField(field)}
                      style={{ width: '18px', height: '18px' }}
                    />
                    <div>
                      <div style={{ fontWeight: '600', textTransform: 'capitalize' }}>{field.replace(/([A-Z])/g, ' $1')}</div>
                      <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                        {shareModal.credentialData.credentialSubject[field]}
                      </div>
                    </div>
                  </label>
                </div>
              ))}
            </div>

            <div className="button-group">
              <button 
                className="btn btn-secondary" 
                onClick={() => setSelectedFields(Object.keys(shareModal.credentialData?.credentialSubject || {}).filter(k => k !== 'id'))}
              >
                Select All
              </button>
              <button 
                className="btn btn-secondary" 
                onClick={() => setSelectedFields([])}
              >
                Clear All
              </button>
            </div>

            <button 
              className="btn btn-success btn-full" 
              onClick={generateShareableCredential}
              disabled={selectedFields.length === 0}
              style={{ marginTop: '1rem' }}
            >
              Generate Shareable Credential ({selectedFields.length} fields)
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
